<h2 id="cloning-oracles-sample-schemas">Cloning Oracle’s Sample Schemas</h2>

<p>he previous post covered using DBMS_METADATA to include DDL operations the files created by EXPORT_SCHEMA and how t these DDL operations can be applied to the target schema before importing the data.This post will cover the testing performed on EXPORT_SCHEMA and IMPORT_JSON. The  success criteria established for the project is to successfully export and import the six Oracle supplied sample schemas. Testing will be performed by using the EXPORT_SCHEMA script to generate an export file for each of schemas and then using IMPORT_SCHEMA script to import each of the files into a newly created schema.  The process should complete without any FATAL errors being recorded in the log records generated by the import process.</p>

<p>The results of running the tests with each of the sample schemas is shown in the following table:</p>

<table>
  <thead>
    <tr>
      <th>Schema</th>
      <th>EXPORT_SCHEMA</th>
      <th>IMPORT_JSON (DDL)</th>
      <th>IMPORT_JSON (DML)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>HR</td>
      <td>✔️</td>
      <td>✔️ (Duplicates)</td>
      <td>✔️</td>
    </tr>
    <tr>
      <td>SH</td>
      <td>✔️</td>
      <td>✔️ (Duplicates)</td>
      <td>❌ (Materialized Views)</td>
    </tr>
    <tr>
      <td>OE</td>
      <td>✔️</td>
      <td>✔️ (Duplicates,References)</td>
      <td>❌(Objects, Mutating Table)</td>
    </tr>
    <tr>
      <td>PM</td>
      <td>✔️</td>
      <td>✔️ (Duplicates,References)</td>
      <td>❌(Objects)</td>
    </tr>
    <tr>
      <td>IX</td>
      <td>✔️</td>
      <td>✔️ (Duplicates,References,AQ)</td>
      <td>❌(Objects)</td>
    </tr>
    <tr>
      <td>BI</td>
      <td>✔️</td>
      <td>✔️</td>
      <td>✔️(No data to import)</td>
    </tr>
  </tbody>
</table>

<p>At this point the EXPORT_SCHEMA and IMPORT_JSCHEMA scripts can be used to clone the HR and BI schemas. However further modifications are required to handle the issues that arise when attempting to clone the SH, OE, PM and IX schemas</p>

<p>Cloning the SH Schema fails when it attempts an “INSERT as SELECT” operation on a materialized view. The cause of the problem is EXPORT_SCHEMA included the content of the materialized view in the export file. Materialized views are included because they appear in the view ALL_ALL_TABLES, which is referenced in the SQL used by GENERATE_STATEMENETS to determine which objects to export. The solution to this problem is to simply exclude materialized views from the export file.</p>

<p>Materialized views are excluded from the export file by adding a left outer join with ALL_MVIEWS to  the SQL used by GENERATE_STATEMENTS and applying a filter that removes rows where MVIEW_NAME is not null. The code for this is shown below</p>

<pre><code class="language-SQL">    from ALL_ALL_TABLES aat
         inner join ALL_TAB_COLS atc
                 on atc.OWNER = aat.OWNER
                and atc.TABLE_NAME = aat.TABLE_NAME
    left outer join ALL_TYPES at
                 on at.TYPE_NAME = atc.DATA_TYPE
                and at.OWNER = atc.DATA_TYPE_OWNER
    left outer join ALL_MVIEWS amv
		         on amv.OWNER = aat.OWNER
		        and amv.MVIEW_NAME = aat.TABLE_NAME
   where aat.STATUS = 'VALID'
     and aat.DROPPED = 'NO'
     and aat.TEMPORARY = 'N'
     and aat.EXTERNAL = 'NO'
     and aat.NESTED = 'NO'
     and aat.SECONDARY = 'N'
     and (aat.IOT_TYPE is NULL or aat.IOT_TYPE = 'IOT')
     and (
           ((TABLE_TYPE is NULL) and (HIDDEN_COLUMN = 'NO'))
         or 
           (
               (TABLE_TYPE is not NULL) 
               and 
               (COLUMN_NAME in ('SYS_NC_ROWINFO$','SYS_NC_OID$','ACLOID','OWNERID'))
           )
         )        
	 and amv.MVIEW_NAME is NULL
     and aat.OWNER = P_SCHEMA
   group by aat.OWNER, aat.TABLE_NAME;
</code></pre>

<p>Cloning the OE schema fails when importing the ORDER_ITEMS table due to a  “mutating table” error. The error occurs because there is a trigger on the table that prevents bulk operations, such as INSERT as SELECT from executing. This issue is solved by modifying IMPORT_JSON to catch the mutating table exception, and re-attempt the import operation using a PL/SQL cursor that inserts the rows one at a time.</p>

<p>Cloning OE, PM and IX schemas also fails due to issues related to Oracle object types. EXPORT_SCHEMA required custom PL/SQL code to serialize objects, and custom PL/SQL is required to parse the serialized representation. Oracle does not expose a generic parser for Oracle objects, fortunately there is a relatively simple solution, all that is required to parse the object is to wrap the serialized representation of the object in a “select … from dual” operation and execute the code using EXECUTE IMMEDIATE. This causes Oracle to parse the object and return an instance of the object type. A separate function is required for each type of object, as the function definition must specify the type of object returned. The required set of functions needs to be added to a WITH clause that is added to the SQL used to ingest the JSON.</p>

<p>The test folder contains two scripts that can be used to validate whether or not the export / import process successfully cloned the source schema. VALIDATE_STRUCTURE compares the entries in view ALL_OBJECTS for the source and target schema, and generates a report showing any inconsistencies  that occur after the IMPORT _JSON operation is complete. VALIDATE_CONTENT uses the SQL minus operator to compare the content of each table in the source and target schema, and generates a summary report showing the number of mismatched rows.</p>

